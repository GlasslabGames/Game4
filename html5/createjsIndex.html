<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>Creature Caretaker</title>
    <script type="text/javascript" src="https://code.createjs.com/createjs-2014.12.12.min.js"></script>
    <script type="text/javascript">
        var global = {
            clickPoint: null
        };

        window.onload = function() {
            stage = new createjs.Stage("demoCanvas");

            manifest = [
                {src:"assets/images/copy-that-floppy.png", id:"floppy"},
                {src:"assets/images/mushroom2.png", id:"1up"}
            ];

            loader = new createjs.LoadQueue(false);
            loader.addEventListener("complete", handleComplete);
            loader.loadManifest(manifest);
        }

        function handleComplete() {
            var stage = new createjs.Stage("demoCanvas");
            global.stage = stage;
            global.stageDirty = true;

            var container = new createjs.Container();
            container.name = "container";
            container.addEventListener("pressup", handleUp);
            container.addEventListener("mousedown", handlePress);
            container.addEventListener("pressmove", handleMove);
            container.addEventListener("onInitiate", function(){ console.log("Initiate heard!"); });
            container.x = 100;
            container.y = 100;
            stage.addChild(container);

            var image = new createjs.Bitmap(loader.getResult("floppy"));
            container.addChild(image);
            image.name = "floppy";
            image.regX = image.image.width/2;
            image.regY = image.image.height/2;

            var container2 = new createjs.Container();
            container2.name = "container2";
            container2.addEventListener("pressup", handleUp);
            container2.addEventListener("mousedown", handlePress);
            container2.addEventListener("pressmove", handleMove);
            container2.addEventListener("onInitiate", function(){ console.log("Initiate heard!"); });
            container2.x = 200;
            container2.y = 20;
            container.addChild(container2);

            var image2 = new createjs.Bitmap(loader.getResult("1up"));
            image2.name = "1UP";
            image2.regX = image2.image.width/2;
            image2.regY = image2.image.height/2;
            container2.addChild(image2);

            var container3 = new createjs.Container();
            container3.name = "container3";
            container3.addEventListener("pressup", handleUp);
            container3.addEventListener("mousedown", handlePress);
            container3.addEventListener("pressmove", handleMove);
            container3.addEventListener("onInitiate", function(){ console.log("Initiate heard!"); });
            container2.addChild(container3);
            container3.x = 20;
            container3.y = 200;

            var image3 = new createjs.Bitmap(loader.getResult("1up"));
            image3.name = "1UP";
            image3.regX = image3.image.width/2;
            image3.regY = image3.image.height/2;
            container3.addChild(image3);

            createjs.Ticker.addEventListener("tick", onTick);

            image2.dispatchEvent("onInitiate");

            stage.update();
        };

        function onTick()
        {
            if (global.stageDirty)
            {
                global.stageDirty = false;
                global.stage.update();
            }
        }

        function handleUp(mouseEvent)
        {
            if (mouseEvent.target.parent != mouseEvent.currentTarget) return;

            var dX = mouseEvent.stageX - global.clickPoint.x;
            var dY = mouseEvent.stageY - global.clickPoint.y;
            if (dX * dX + dY * dY <= 1)
            {
                if (mouseEvent.currentTarget.scaleX != 2) mouseEvent.currentTarget.scaleX = 2;
                else mouseEvent.currentTarget.scaleX = 1;
                global.stageDirty = true;
            }

            console.log("pressup! " + mouseEvent.currentTarget.parent instanceof createjs.Container);
        }

        function handlePress(mouseEvent)
        {
            global.clickPoint = new createjs.Point(mouseEvent.stageX, mouseEvent.stageY);
        }

        function handleMove(mouseEvent)
        {
            if (mouseEvent.target.parent != mouseEvent.currentTarget) return;
            console.log("move!");
            var localPoint = mouseEvent.currentTarget.globalToLocal(mouseEvent.stageX, mouseEvent.stageY);
            mouseEvent.currentTarget.x += localPoint.x;
            mouseEvent.currentTarget.y += localPoint.y;

            global.stageDirty = true;
        }
    </script>
</head>
<body>

<canvas id="demoCanvas" width="1024" height="768"></canvas>

<div id="gameContainer"></div>

</body>
</html>