<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>Creature Caretaker</title>
    <script src="phaser/build/phaser.js"></script>
    <script src="js/src/AE.js"></script>
    <script type="text/javascript">
        // create a new loader
        //loader = new PIXI.AssetLoader(assetsToLoader);

        // use callback
        //loader.onComplete = onAssetsLoaded;

        //begin load
        //loader.load();
        var global = {};

        window.onload = function() {
            var game = new Phaser.Game(800, 600, Phaser.AUTO, 'gameContainer', { preload: preload, create: create, update: update});
            function preload() {
                game.load.image('disk', 'assets/images/copy-that-floppy.png');
                game.load.image('1UP', 'assets/images/mushroom2.png');
                game.load.image('test', 'assets/images/test.png');
                game.load.atlasJSONHash('sheep', 'assets/images/sheepAnim.png', 'assets/images/sheepAnim.json');
            }

            var parent;
            var child;
            var child2;
            var dragObject;
            var dragOrigin;
            var dragDelta;

            function create()
            {
                var sheep = game.add.sprite(100,0,'sheep');
                sheep.animations.add('run');
                sheep.animations.play('run', 48, true);

                parent = game.add.sprite(100, 100, 'disk');
                parent.inputEnabled = true;
                parent.anchor.x = parent.anchor.y = .5;
                parent.z = 2;
                parent.name = 'disk';
                parent.events.onInputUp.add(onUp, this);
                parent.events.onInputDown.add(onDown, this);

                child = game.make.sprite(0, 0, '1UP');
                child.name = "1UP";
                child.anchor.x = child.anchor.y = .5;
                child.x = 200;
                child.y = 50;
                child.z = 0;
                child.inputEnabled = true;
                child.input.priorityID = 1;
                child.events.onInputUp.add(onUp, this);
                child.events.onInputDown.add(onDown, this);
                parent.addChild(child);

                child2 = game.make.sprite(0, 0, '1UP');
                child2.name = "1UP";
                child2.anchor.x = child2.anchor.y = .5;
                child2.x = 50;
                child2.y = 250;
                child2.z = 1;
                child2.inputEnabled = true;
                child2.input.priorityID = 2;
                child2.events.onInputUp.add(onUp, this);
                child2.events.onInputDown.add(onDown, this);
                child.addChild(child2);

                game.world.sort('z', Phaser.Group.SORT_ASCENDING);

                global.text = game.add.text(350, 560, "Loading...", { fill:"#fff" }).name = "Text";

                game.scale.fullScreenScaleMode = Phaser.ScaleManager.RESIZE;
                game.input.onDown.add(gofull, this);

            }

            function gofull() {

                if (!game.scale.isFullScreen)
                {
                    game.scale.startFullScreen(false);
                }
            }

            function update(game)
            {
                if (dragObject)
                {
                    var localPoint;
                    if (dragObject.parent)
                    {
                        localPoint = dragObject.parent.toLocal(new PIXI.Point(game.input.x, game.input.y));
                    }
                    else
                    {
                        localPoint = new PIXI.Point(game.input.x, game.input.y);
                    }

                    dragObject.x = localPoint.x - dragDelta.x;
                    dragObject.y = localPoint.y - dragDelta.y;
                }

                if (global.animation)
                {
                    global.animation.update(game.time.elapsed);
                }
            }

            function onDown(sprite, pointer)
            {
                dragObject = sprite;
                dragOrigin = new PIXI.Point(pointer.screenX, pointer.screenY);
                var localPoint;
                if (dragObject.parent)
                {
                    localPoint = dragObject.parent.toLocal(new PIXI.Point(game.input.x, game.input.y));
                }
                else
                {
                    localPoint = new PIXI.Point(game.input.x, game.input.y);
                }
                dragDelta = new PIXI.Point(localPoint.x - dragObject.x, localPoint.y - dragObject.y);
            }

            function onUp(sprite, pointer)
            {
                dragObject = null;
                dragOrigin.subtract(pointer.screenX, pointer.screenY);
                if (dragOrigin.getMagnitudeSq() <= 1)
                {
                    var o = sprite;
                    if (o.scale.x == 2)
                        o.scale.x = 1;
                    else
                        o.scale.x = 2;
                }
            }
        };
    </script>
</head>
<body>

<div id="gameContainer"></div>

</body>
</html>